<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>009 GROUP</title>

    <!-- select 2 -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>

    <link rel="stylesheet" href="css/main.css">

    <!-- /////////////////////////////////////////////////////////////////////////////////////////////// -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script> <!-- JQuery -->
    <!-- /////////////////////////////////////////////////////////////////////////////////////////////// -->


</head>
<body>

<div class="main-body">
    <div class="header-page">
        <div class="header-icon"><img src="images/009_Group_LOGO_gor_new.svg" alt="service icon"
                                      class="header-icon-img"></div>
        <div class="header-consultation"></div>
    </div>

    <div class="page-title">Welcome<br>Please select an appointment date and time</div>

    <div class="main">
        <div class="main-content">
            <div id="calendar">
                <div class="header">
                    <button id="prev">Previous</button>
                    <h2 id="month-year"></h2>
                    <button id="next">Next</button>
                </div>
                <div class="days">
                    <div class="day">Sun</div>
                    <div class="day">Mon</div>
                    <div class="day">Tue</div>
                    <div class="day">Wed</div>
                    <div class="day">Thu</div>
                    <div class="day">Fri</div>
                    <div class="day">Sat</div>
                </div>
                <div id="dates"></div>
            </div>
        </div>

        <!-- Modal Form -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <div class="form appointment-form" id="appointment-form">
                    <div class="title">Record form</div>
                    <div class="input-container ic2">
                        <input id="firstname" class="input" type="text" placeholder=" "/>
                        <div class="cut"></div>
                        <label for="firstname" class="placeholder">First name</label>
                    </div>
                    <div class="input-container ic2">
                        <input id="lastname" class="input" type="text" placeholder=" "/>
                        <div class="cut"></div>
                        <label for="lastname" class="placeholder">Last name</label>
                    </div>
                    <div class="input-container ic2">
                        <input id="timeSlot" class="input" type="text" name="timeSlot" placeholder=" " readonly>
                        <div class="cut"></div>
                        <label for="timeSlot" class="placeholder">Time Slot</label>
                    </div>

                    <div class="input-container ic2">
                        <input id="phone" class="input" type="text" name="phone" placeholder="">
                        <div class="cut"></div>
                        <label for="phone" class="placeholder">Phone Number</label>
                    </div>

                    <div class="input-container ic2">
                        <input id="Comments" class="input" type="text" name="Comments" placeholder=" ">
                        <div class="cut"></div>
                        <label for="Comments" class="placeholder">Comments</label>
                    </div>

                    <div class="toggle-button" id="toggleCarInfo">
                        <div class="toggle-button-header">Car Parameters</div>
                        <div class="toggle-button-icon"><img src="./images/Arrow_Bottom.svg" alt="Arrow_Bottom"></div>
                    </div>

                    <div class="subform hidden" id="car-subform">
                        <div class="input-container ic2">
                            <input id="car-make" class="input" type="text" name="carMake" placeholder=" ">
                            <div class="cut"></div>
                            <label for="car-make" class="placeholder">License plate number</label>
                        </div>
                        <div class="input-container ic2">
                            <select id="brand" class="select2 brand input" name="brand">
                                <option value="" disabled selected hidden></option>
                            </select>
                            <div class="cut"></div>
                            <label for="brand" class="placeholder">Car brand</label>
                        </div>
                        <div class="input-container ic2">
                            <select id="model" class="select2 model input" name="model">
                                <option value="" disabled selected hidden></option>
                            </select>
                            <div class="cut"></div>
                            <label for="model" class="placeholder">Car model</label>
                        </div>
                        <div class="input-container ic2">
                            <input id="mileage" class="input" type="text" name="mileage" placeholder=" ">
                            <div class="cut"></div>
                            <label for="mileage" class="placeholder">Mileage</label>
                        </div>
                        <div class="input-container ic2">
                            <select id="unitOfMeasurement" class="input" name="unitOfMeasurement">
                                <option value="" disabled selected hidden></option>
                                <option value="km">Kilometers (km)</option>
                                <option value="miles">Miles (mi)</option>
                                <option value="liters">Liters (L)</option>
                                <option value="gallons">Gallons (gal)</option>
                            </select>
                            <div class="cut"></div>
                            <label for="unitOfMeasurement" class="placeholder">Unit of measurement</label>
                        </div>
                    </div>


                    <div class="submit-div">
                        <button id="submitForm" class="submit" disabled>Submit</button>
                    </div>
                </div>

            </div>
        </div>

    </div>

</div>

<!-- /////////////////////////////////////////////////////////////////////////////////////////////// -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- /////////////////////////////////////////////////////////////////////////////////////////////// -->
<script src="js/error-handling/errors.js"></script> <!-- error handling -->

<script src="js/configs/configs.js"></script> <!-- Get All values and URLs  -->

<script src="js/make-request.js"></script> <!-- function for build Request -->

<script src="js/request-function.js"></script> <!-- function for send Request -->

<script src="js/request-template.js"></script> <!-- Request function -->

<script src="js/main.js"></script> <!-- work code -->
<!-- /////////////////////////////////////////////////////////////////////////////////////////////// -->


<script>
    $(document).ready(async function () {

        const TimeZoneId = await getTimeZoneId(requestConst.sto_id);
        const timeZoneData = await getTimeZoneData(TimeZoneId);
        timeZoneObjectData = {...timeZoneData}

        initializeCalendar({
            calendarSelector: '#calendar',
            monthYearSelector: '#month-year',
            datesSelector: '#dates',
            prevButtonSelector: '#prev',
            nextButtonSelector: '#next',
        });

        await getBrands({"_type": "brand"});


        // Close modal when clicking outside of the form
        $(document).on('click', function (e) {
            // Перевірка, чи натиснуто на модальне вікно або його елементи
            if (!$(e.target).closest('.modal-content').length &&
                !$(e.target).is('#calendar, #calendar *') &&
                !$(e.target).closest('.select2-container').length) {
                $('#modal').fadeOut();
            }
        });


        $('#brand, #model, #unitOfMeasurement').select2({
            placeholder: "Select an option",
        });


        // submit(record) event
        $('#submitForm').on('click', async function (e) {
            e.preventDefault();

            await getOrderTemplateData(requestConst.sto_id);

            const timeSlot = $('#timeSlot').val();
            const appointmentDate = $('.date.selected').text();
            const monthYearText = $('#month-year').text();

            // Update the page title with the success message
            $('.page-title').html(`Appointment successfully booked for ${appointmentDate} ${monthYearText} at ${timeSlot} <img src="images/successful_icon.svg" alt="successful" class="successful-icon">`);

            $('#modal').fadeOut();
            $('.main-content').fadeOut();

            const selectedBrand = $("#brand").find(":selected");
            const brandData = selectedBrand.data("brand");

            const selectedOption = $("#model").find(":selected");
            const modelData = selectedOption.data("model");

            createOrderObject.data.client_comment___content = $('#Comments').val();

            createOrderObject.data.client___users = JSON.stringify([{
                "phone": $('#phone').val(),
                "name": `${$('#firstname').val()} ${$('#lastname').val()}`,
                "email": "",
                "type": "default",
                "priceTypeName": "",
                "internal_id": ""
            }]);

            createOrderObject.data.client___cars = JSON.stringify([{
                "brand": brandData?.internal_id || '',
                "brandName": brandData?.brand_name || '',
                "internal_id": "",
                "isOwner": false,
                "model": modelData?.internal_id || '',
                "modelName": modelData?.model_name || '',
                "stateNumber": $('#car-make').val() || '',
                "vin": "",
                "year": ""
            }]);

            const timeNow = new Date().toISOString();
            createOrderObject.data.settings___statuses_times = JSON.stringify({
                "register_at": timeNow,
                "check_in_at": "",
                "canceled_at": "",
                "created_at": timeNow
            })

            createOrderObject.data.client___name = `${$('#firstname').val()} ${$('#lastname').val()}`;
            createOrderObject.data.car___state_number = $('#car-make').val() || '';
            createOrderObject.data.car___brand = brandData?.internal_id || '';
            createOrderObject.data.car___brand_name = brandData?.brand_name || '';
            createOrderObject.data.car___model = modelData?.internal_id || '';
            createOrderObject.data.car___model_name = modelData?.model_name || '';

            createOrderObject.data.settings___register_at = timeNow;
            createOrderObject.data.general___start_date = $('#timeSlot').data('general___start_date');
            createOrderObject.data.general___start_time = $('#timeSlot').data('general___start_time');

            const createResponse = await createOrder(createOrderObject);
            console.log(createResponse);
        });


        // toggle car parameters
        $('#toggleCarInfo').on('click', function () {
            $('#car-subform').slideToggle().css('display', 'flex');
            $('.toggle-button-icon > img').toggleClass('rotate-icon');
        });

        // Event for choosing brand
        $('#brand').on('change', async function () {
            const id = $(this).attr('id');

            const selectObject = {
                "_type": "model",
                "brand_name_inscription": $(this).val()
            };

            // Calling the function to retrieve models, passing the selected brand
            if (id === 'brand') {
                await getModels(selectObject);
            }
        });


        // check required inputs in form
        $('#firstname, #phone').on('input', validateInputs);


        // we can write only numbers
        $('#mileage').on('input', function () {
            const currentValue = $(this).val();
            const filteredValue = currentValue.replace(/[^0-9]/g, '');
            $(this).val(filteredValue);
        });


        // rerender page on click company icon and successful icon
        $('.header-icon-img, .successful-icon').on('click', function () {
            location.reload();
        });

    });

</script>

</body>
</html>
